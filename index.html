<!DOCTYPE html>

<html>
	<head>
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="https://d3js.org/queue.v1.min.js"></script>
		<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>  

		<style>

			#display {
				width: 300px,
				height: 300px;
				border: solid 2px black;
				display: none;
			};	

			#postViz {
				width: 100%;
				height: 400px;
				border: 10px solid red;
			}

			#svgContainer {
				width: 500;
				height: 500;
			}

			#svgContainer2 {
				width: 500;
				height: 500;
			}

			#postText {
				border: 1px solid blue;
			}

			#repContainer {
				border: 1px solid green;	
			}

		</style>

	</head>

	<body>

		<div id="display"></div>
		<div id="userInputBox">
			fix user input field at top of page
			Type in your address to search for your House representative
			<input type="text" id="addressInput">
			<a href=# id="submit_text">submit</a>
		</div>
		<div id="postContainer">
			<div id="postViz">
				<div id="svgContainer"></div>
				<div id="svgContainer2"></div>
			</div>

			<div id="postText">This is post text.</div> 

			<div id="repContainer">
			</div>

		</div>
		<script>
			var userAddress = $("#addressInput").val();
			//var userAddress = "11205 Bellaire Blvd, Houston, TX 77072";
			//var userAddress = "22406 Ventura Blvd, Woodland Hills, CA 91364"

			var stateabbrev2namecode = '{"AL": {"state_name": "Alabama", "state_code": "01"}, "AK": {"state_name": "Alaska", "state_code": "02"}, "AZ": {"state_name": "Arizona", "state_code": "04"}, "AR": {"state_name": "Arkansas", "state_code": "05"}, "CA": {"state_name": "California", "state_code": "06"}, "CO": {"state_name": "Colorado", "state_code": "08"}, "CT": {"state_name": "Connecticut", "state_code": "09"}, "DE": {"state_name": "Delaware", "state_code": "10"}, "DC": {"state_name": "District of Columbia", "state_code": "11"}, "FL": {"state_name": "Florida", "state_code": "12"}, "GA": {"state_name": "Georgia", "state_code": "13"}, "HI": {"state_name": "Hawaii", "state_code": "15"}, "ID": {"state_name": "Idaho", "state_code": "16"}, "IL": {"state_name": "Illinois", "state_code": "17"}, "IN": {"state_name": "Indiana", "state_code": "18"}, "IA": {"state_name": "Iowa", "state_code": "19"}, "KS": {"state_name": "Kansas", "state_code": "20"}, "KY": {"state_name": "Kentucky", "state_code": "21"}, "LA": {"state_name": "Louisiana", "state_code": "22"}, "ME": {"state_name": "Maine", "state_code": "23"}, "MD": {"state_name": "Maryland", "state_code": "24"}, "MA": {"state_name": "Massachusetts", "state_code": "25"}, "MI": {"state_name": "Michigan", "state_code": "26"}, "MN": {"state_name": "Minnesota", "state_code": "27"}, "MS": {"state_name": "Mississippi", "state_code": "28"}, "MO": {"state_name": "Missouri", "state_code": "29"}, "MT": {"state_name": "Montana", "state_code": "30"}, "NE": {"state_name": "Nebraska", "state_code": "31"}, "NV": {"state_name": "Nevada", "state_code": "32"}, "NH": {"state_name": "New Hampshire", "state_code": "33"}, "NJ": {"state_name": "New Jersey", "state_code": "34"}, "NM": {"state_name": "New Mexico", "state_code": "35"}, "NY": {"state_name": "New York", "state_code": "36"}, "NC": {"state_name": "North Carolina", "state_code": "37"}, "ND": {"state_name": "North Dakota", "state_code": "38"}, "OH": {"state_name": "Ohio", "state_code": "39"}, "OK": {"state_name": "Oklahoma", "state_code": "40"}, "OR": {"state_name": "Oregon", "state_code": "41"}, "PA": {"state_name": "Pennsylvania", "state_code": "42"}, "RI": {"state_name": "Rhode Island", "state_code": "44"}, "SC": {"state_name": "South Carolina", "state_code": "45"}, "SD": {"state_name": "South Dakota", "state_code": "46"}, "TN": {"state_name": "Tennessee", "state_code": "47"}, "TX": {"state_name": "Texas", "state_code": "48"}, "UT": {"state_name": "Utah", "state_code": "49"}, "VT": {"state_name": "Vermont", "state_code": "50"}, "VA": {"state_name": "Virginia", "state_code": "51"}, "WA": {"state_name": "Washington", "state_code": "53"}, "WV": {"state_name": "West Virginia", "state_code": "54"}, "WI": {"state_name": "Wisconsin", "state_code": "55"}, "WY": {"state_name": "Wyoming", "state_code": "56"}}';

			function findCD(userAddress, callback) {
				/** 
				find user's congressional district given address using Google Civics API 
				docs: https://developers.google.com/civic-information/docs/using_api#voterinfoquery-using-curl
				**/

				var electionID = 6000	// for midterms 2018, find by making electionQuery (docs)

				var req = gapi.client.request({
					"path": "/civicinfo/v2/representatives",
					"params": {"electionId": electionID, "address":userAddress}
				});

				req.execute(callback);

				//console.log("findcd stabbrev:", stateabbrev2namecode);

			};

			function findCDSuccess(response, rawResponse) {
				//console.log("response:", response["divisions"]);
				var divisionsArray = Object.keys(response["divisions"]);
				var stcdString = divisionsArray[2];
				console.log("stcdString:", stcdString);

				var regexST = /state:([a-z]+)/;
				var regexCD = /cd:([0-9]+)/;

				var stabbrev = stcdString.match(regexST)[1].toUpperCase();
				var cd = stcdString.match(regexCD)[1];
				if (cd.length == 1) {cd = "0"+cd};	// make cd two digits

				//console.log("regex state:", stabbrev);
				//console.log("regex cd:", cd);

				// map stabbrev to state FIPS code
				var stateabbrev2namecodeObj = JSON.parse(stateabbrev2namecode);
				//console.log("state_code:", stateabbrev2namecodeObj[stabbrev]["state_code"]);

				var state_code = stateabbrev2namecodeObj[stabbrev]["state_code"];

				stcd_code = state_code + cd;
				console.log("stcd_code:", stcd_code);

				// jump to rep card given stcd_code
				// jump2rep(stcd_code);

			};

			function jump2rep(stcd_code) {
				// jump to rep card given stcd_code
				repElement = document.getElementById(stcd_code);
				if (repElement != null) {
					repElement.scrollIntoView({"behavior":"instant"});
				};
			}
			
			function makeVizOppose(dataArray) {

				var width = 500;
				var height = 500;
				//var margin = {top: 20, right: 0, bottom: 30, left: 40};

				// initiate svg canvas
				var canvas = d3.select("#svgContainer").append("svg")
						.attr("width", width)
						.attr("height", height)
	                        .append("g");
	                        //  .attr("transform","translate(50,-30)");  
				
				// invert bar chart by subtracting height of each bar from a value larger than the max height
				var bars = canvas.selectAll("rect")
							.data(dataArray)
							.enter()
								.append("rect")
								.attr("width", 1)
								.attr("height", function(d){
									if (d["rep_oppose_aca"] == "Y") {return (parseFloat(d["cd_pct_unins"]) * 1000).toFixed(0);}
								})
								.attr("x", function(d,i){return i*1;})
								.attr("y", function(d,i){return 500-(parseFloat(d["cd_pct_unins"]) * 1000).toFixed(0)})
								.attr("fill", function(d,i){
									if (d["rep_party"] == "republican") {return "red"}
									if (d["rep_party"] == "democrat") {return "blue"}
								});
			};

			function makeVizSupport(dataArray) {

				// reference: https://beta.observablehq.com/@mbostock/d3-bar-chart

				var width = 500;
				var height = 300;
				//var margin = {top: 20, right: 0, bottom: 30, left: 40};

				// initiate svg canvas
				var canvas = d3.select("#svgContainer2").append("svg")
						.attr("width", width)
						.attr("height", height)
	                        .append("g");
	                        //  .attr("transform","translate(50,-30)");  

				// invert bar chart by subtracting height of each bar from a value larger than the max height
				var bars = canvas.selectAll("rect")
							.data(dataArray)
							.enter()
								.append("rect")
								.attr("width", 5)
								.attr("height", function(d){
									if (d["rep_oppose_aca"] == "N") {return (parseFloat(d["cd_pct_unins"]) * 1000).toFixed(0);}
								})
								.attr("x", function(d,i){return i*1;})
								.attr("y", function(d,i){return 500-(parseFloat(d["cd_pct_unins"]) * 1000).toFixed(0)})
								.attr("fill", function(d,i){
									if (d["rep_party"] == "republican") {return "red"}
									if (d["rep_party"] == "democrat") {return "blue"}
								});
			};

			function makeRepCards(dataArray) {

				for (var i=0; i<dataArray.length; i++) {
					var record = dataArray[i];

					//console.log("rep cards record:", i)

					// grab and prettify info for display 
					var stcdCode = record["stcd_code"];	// make this part of href tag so can reference when user inputs address using Google Civics API (relurl/#stcdCode)
					var stateName = record["state_name"];
					var district = "District " + record["district"];
					var repName = record["rep_name"];
					var repParty = record["rep_party"];
					var totalUnins = parseFloat(record["cd_total_unins"]).toFixed(0);
					var pctUnins = (record["cd_pct_unins"]*100).toFixed(1) + "%";
					var repOpposeACA = "Opposes Obamacare? " + record["rep_oppose_aca"];
					var repPhotoUrl = record["rep_photo_url"];
					var repContactPage = record["rep_contact_page"];
					var repPhone = record["rep_phone"];
					var repTwitter = record["rep_twitter"];
					var repFacebook = record["rep_facebook"];

					var femalePct = record["gender_female_pct"];
					var malePct = record["gender_male_pct"];
					// TASK: call rest of demographic records for later


					// insert info into formatted string
					repInfoList = [stateName,district,repName,repParty,repOpposeACA,totalUnins,pctUnins,repContactPage,repPhone,repTwitter,repFacebook];
					var rep_info_html_string = "";
					for (var j=0; j<repInfoList.length; j++) {
						rep_info_html_string += "<p>"+repInfoList[j]+"</p>";
					};

					// render stacked bar chart for demographics 

					// insert all data into card, append to repContainer
					$("#repContainer").append(`<div class="repCard"><div class="repInfoDisplay" id="${stcdCode}"><img src='${repPhotoUrl}'>`+rep_info_html_string+`</div></div>`)
					//$("#repContainer").append(rep_info_html_string);

					// attach bar charts in repChartDisplay, append to repCard

				};

			}


			function main() {

				queue()
					.defer(d3.csv, 'files/cdhealth_records.csv')
					.await(loadFunctions);

				function loadFunctions(error, dataArray) {
					if (error) throw error;

					//console.log("stabbrev:", stateabbrev2namecode)

					// Find congressional district given user address input
					$("#submit_text").on("click", function{
						gapi.client.setApiKey('AIzaSyBdwLeB6a9ZTuLuEdYlM_JClg6FndXjfTs');
						findCD(userAddress, findCDSuccess);
					});

					//console.log(JSON.stringify(dataArray));
					//console.log(dataArray[0]["testkey"]);
					//console.log(dataArray[0]["cd_pct_unins"]);
					//console.log(typeof dataArray[0]["cd_pct_unins"]);
				
					//makeVizOppose(dataArray);
					//makeVizSupport(dataArray);
					makeRepCards(dataArray);

					//findCD(userAddress)
				};				

			};




			/** CALL FUNCTIONS **/
			//$(document).ready(main());

		</script>

		<script src="https://apis.google.com/js/client.js?onload=main"></script>





	</body>

</html>